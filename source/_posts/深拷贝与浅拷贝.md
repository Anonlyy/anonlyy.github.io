---
title: JavaScript的深拷贝与浅拷贝
date: 2017-12-25 10:49:36
tags:
---


在掌握深浅拷贝前,我们要知道,`JavaScript`的变量可以分为以下两种类型：


- 基本类型
  - undefined
  - null
  - number
  - string
  - boolean
  - symbol



> 基本变量是直接按值存放的，存放在栈内存中的简单数据段，可以直接访问。


- 引用类型 Object、Function、Array

> 存放在堆内存中的对象，变量保存的是一个**指针**，这个指针指向另一个位置。当需要访问引用类型（如对象，数组等）的值时，首先从栈内存中获得该对象的地址指针，然后再从堆内存中取得所需的数据。

## 概念

**浅拷贝(shallowCopy)**:
对于字符串类型，浅拷贝是对值的复制，对于对象来说，浅拷贝是对对象地址的复制，并不会开辟新的内存地址，也就是复制的结果是两个对象指向同一个地址，修改其中一个对象的属性，则另一个对象的属性也会改变;

**深拷贝(deepCopy)**:
而深拷贝则是开辟新的内存地址，将原对象的各个属性逐个复制进去，两个对象对应两个不同的地址，修改一个对象的属性，不会改变另一个对象的属性。


## 深浅拷贝的实现

### 实现浅拷贝

#### 1.Object.assign
Object.assign() 方法用于将所有可枚举属性的值从一个或多个源对象复制到目标对象。它将返回目标对象,这也是实现浅拷贝常用的方法之一.

	let obj1 = { a: 0 , b: { c: 0}};
	let obj2 = Object.assign({}, obj1);
	console.log(JSON.stringify(obj2)); // { a: 0, b: { c: 0}}


#### 2.遍历对象属性赋值

之前一直有一个错误实现深拷贝的想法，就是遍历一个对象的Key-Value对并一一复制给另一个对象便可以实现深拷贝。

但是是错误的，这个是浅拷贝(shallowCopy)

原因很简单，当Kry-Value对里value是Object的时候，复制过去便仍然是复制引用。


	let obj = {
	    a: 1,
	    b:{
	        c: 2,
	        d: 3
	    }
	}
	
	let obj2 = {}
	
	for(let item of Object.keys(obj)){
	    obj2[item] = obj[item]
	}
	
	obj2.b.d = 2; 
	
	obj.b.d // 此时obj.b.d 变成了2,所以是浅拷贝

---

### 实现深拷贝

#### 1.JSON对象的parse和stringify(最简单的)

	let obj1 = { a: 0 , b: { c: 0}};

	let obj2 = JSON.parse(JSON.stringify(obj1));
	
	obj2.b.c = 3;
	console.log(obj2.b.c); // { a: 0 , b: { c: 3}};
	
	console.log(obj1.b.c); // { a: 0 , b: { c: 0}};

该方法思路就是将一个对象转成json字符串，然后又将字符串转回对象。
能够处理`JSON`格式能表示的所有数据类型，但是无法拷贝对象里面的函数，正则表达式等，而且会丧失所有的`constructor`，也就是说，将是破坏整条`prototype`链。


#### 2.JQuery的extend()
我们在 jQuery 中可以通过添加一个参数来实现递归extend。调用`$.extend(true, {}, ...)`就可以实现深复制啦，参考下面的例子：

	var x = {
	    a: 1,
	    b: { f: { g: 1 } },
	    c: [ 1, 2, 3 ]
	};
	
	var y = $.extend({}, x),          //shallow copy
	    z = $.extend(true, {}, x);    //deep copy
	
	y.b.f === x.b.f       // true
	z.b.f === x.b.f       // false


#### 3.Lodash的深拷贝
`Lodash` 是一套基于`JavaScript`的工具库，它内部封装了诸多对字符串、数组、对象等常见数据类型的处理函数，其中部分是目前 `ECMAScript` 尚未制定的规范，但同时被业界所认可的辅助函数。目前每天使用 `npm` 安装 `Lodash` 的数量在百万级以上，这在一定程度上证明了其代码的健壮性，值得我们在项目中一试。
`jQuery`无法深拷贝`JSON`对象以外的对象,但`Lodash`在源代码已经兼顾到许多ES6引入的新标准对象,所以在可用性上,比其他第三方库文件反馈更好,可用性更强.


	var objects = [{ 'a': 1 }, { 'b': 2 }];
	 
	var deep = _.cloneDeep(objects);
	console.log(deep[0] === objects[0]);
	// => false

	


## 总结

1. 基本类型变量存贮在栈内存区,存放在堆内存中的对象，变量保存的是一个指针。
2. 直接遍历对象一一复制是浅拷贝(shallowCopy)
3. 深拷贝即是在堆内存区拷贝出一个对象来。
4. 深拷贝当然更占内存，请一定要针对不同的场景做不同的拷贝处理。